/** 
 * <feature scope="SanteDB.Persistence.PubSub.ADO" id="20210311-01" name="Update:20210311-01" applyRange="1.1.0.0-1.2.0.0"  invariantName="sqlite">
 *	<summary>Update: Installs the Pub/Sub ADO Tables</summary>
 *	<remarks>This table is used to register channels and subscriptions</remarks>
 *  <isInstalled mustSucceed="true">SELECT EXISTS (SELECT 1 FROM sqlite_master WHERE type='table' AND name='SUB_CHNL_TBL')</isInstalled>
 * </feature>
 */


-- SUBSCRIPTION CHANNEL
CREATE TABLE SUB_CHNL_TBL (
	CHNL_ID blob(16) NOT NULL DEFAULT (randomblob(16)),
	CRT_UTC BIGINT NOT NULL DEFAULT (unixepoch()),
	CRT_USR_ID blob(16) NOT NULL,
	UPD_UTC BIGINT,
	UPD_USR_ID blob(16),
	OBSLT_UTC BIGINT,
	OBSLT_USR_ID blob(16),
	IS_ACT BOOLEAN NOT NULL DEFAULT FALSE,
	NAME VARCHAR(64) NOT NULL,
	URI VARCHAR(512) NOT NULL,
	DSPTCHR_CLS VARCHAR(512) NOT NULL, 
	CONSTRAINT PK_SUB_CHNL_TBL PRIMARY KEY (CHNL_ID)
);

CREATE INDEX SUB_CHNL_IDX ON SUB_CHNL_TBL(NAME);


-- CHANNEL SETTINGS
CREATE TABLE SUB_CHNL_SET_TBL (
	SET_ID INTEGER PRIMARY KEY AUTOINCREMENT,
	CHNL_ID blob(16) NOT NULL,
	NAME VARCHAR(64) NOT NULL,
	VAL VARCHAR(512) NOT NULL,
	CONSTRAINT FK_SUB_CHNL_CHNL_TBL FOREIGN KEY (CHNL_ID) REFERENCES SUB_CHNL_TBL (CHNL_ID)
);

CREATE INDEX SUB_CHNL_SET_CHNL_IDX ON SUB_CHNL_SET_TBL(CHNL_ID);

CREATE TABLE SUB_TBL (
	SUB_ID blob(16) NOT NULL DEFAULT (randomblob(16)),
	CRT_UTC BIGINT NOT NULL DEFAULT (unixepoch()),
	CRT_USR_ID blob(16) NOT NULL,
	UPD_UTC BIGINT,
	UPD_USR_ID blob(16),
	OBSLT_UTC BIGINT,
	OBSLT_USR_ID blob(16),
	IS_ACT BOOLEAN NOT NULL DEFAULT FALSE,
	NAME VARCHAR(64) NOT NULL,
	NOTE TEXT, 
	SPPRT VARCHAR(256),
	NBF BIGINT CHECK(NBF > unixepoch()),
	NAF BIGINT,
	RSRC_CLS VARCHAR(512) NOT NULL, 
	EVT_ID INTEGER NOT NULL,
	CHNL_ID blob(16) NOT NULL,
	CONSTRAINT PK_SUB_TBL PRIMARY KEY (SUB_ID),
	CONSTRAINT FK_SUB_CHNL_TBL FOREIGN KEY (CHNL_ID) REFERENCES SUB_CHNL_TBL(CHNL_ID)
);

CREATE UNIQUE INDEX SUB_NAME_IDX ON SUB_TBL(NAME) WHERE (OBSLT_UTC IS NULL);

CREATE TABLE SUB_FLT_TBL (
	FLT_ID INTEGER PRIMARY KEY AUTOINCREMENT,
	SUB_ID blob(16) NOT NULL,
	FLT TEXT NOT NULL,
	CONSTRAINT FK_SUB_FLT_SUB_TBL FOREIGN KEY (SUB_ID) REFERENCES SUB_TBL (SUB_ID)
);
