/** 
 * <feature scope="SanteDB.Persistence.Audit.ADO" id="00010000-00" name="Initialize:001-01" invariantName="sqlite">
 *	<summary>Installs the core schema for SanteDB Audit Repository</summary>
 *	<remarks>This script installs the necessary core schema files for SanteDB</remarks>
 *  <isInstalled mustSucceed="true">SELECT EXISTS (SELECT 1 FROM sqlite_master WHERE type='table' AND name='AUD_CD_TBL')</isInstalled>
 * </feature>
 */


 -- TABLE FOR STORAGE OF AUDIT CODES
 CREATE TABLE AUD_CD_TBL (
	ID	BLOB(16) NOT NULL DEFAULT (RANDOMBLOB(16)), -- UNIQUE IDENTIIFER OF THE CODE
	MNEMONIC VARCHAR(256) NOT NULL, -- THE MNEMONIC OF THE CODE
	CD_SYS VARCHAR(256), -- THE CODIFICATION SYSTEM OF THE CODE IF KNOWN
	CONSTRAINT PK_AUD_CD_TBL PRIMARY KEY (ID)
 );

 CREATE UNIQUE INDEX AUD_CD_MNEMONIC_CD_SYS_IDX ON AUD_CD_TBL(MNEMONIC, CD_SYS);

 -- TABLE FOR STORAGE OF AUDITS
 CREATE TABLE AUD_TBL (
	ID BLOB(16) NOT NULL DEFAULT (RANDOMBLOB(16)), -- UNIQUE IDENTIIFER FOR THE AUDIT
	OUTC_CS INT NOT NULL, -- THE OUTCOME OF THE AUDIT
	ACT_CS INT NOT NULL, -- THE ACTION CODE OF THE AUDIT
	TYP_CS INT NOT NULL, -- THE AUDIT TYPE CODE
	EVT_UTC BIGINT NOT NULL, -- THE TIME THAT THE AUDIT OCCURRED
	CRT_UTC BIGINT NOT NULL DEFAULT (UNIXEPOCH()), -- THE TIME THAT THE AUDIT WAS CREATED
	CLS_CD_ID BLOB(16), -- THE CLASSIFICATION CODE
	CONSTRAINT PK_AUD_TBL PRIMARY KEY (ID),
	CONSTRAINT FK_AUD_CLS_CD_ID FOREIGN KEY (CLS_CD_ID) REFERENCES AUD_CD_TBL(ID)
 );
 
 -- TABLE FOR STORAGE OF AUDIT OBJECTS
 CREATE TABLE AUD_OBJ_TBL (
	ID	INTEGER PRIMARY KEY AUTOINCREMENT, -- UNIQUE IDENTIFIER FOR THE AUDIT OBJECT
	AUD_ID BLOB(16) NOT NULL, -- AUDIT TO WHICH THE OBJECT BELONGS
	OBJ_ID VARCHAR(512), -- THE OBJECT IDENTIFIER
	OBJ_TYP INT, -- THE TYPE OF OBJECT
	ROL_CS INT, -- THE ROLE THE OBJECT PLAYS IN THE AUDIT
	LCYCL_CS INT, -- THE LIFECYCLE OF THE OBJECT
	ID_TYP_CS INT, -- THE IDENTIFIER TYPE CODE
	QRY_DAT TEXT, -- ADDITIONAL QUERY DATA ASSIGNED TO THE OBJECT
	NAM_DAT TEXT, -- ADDITIONAL NAME DATA ASSIGNED TO THE OBJECT
	CST_ID_TYP BLOB(16), -- CUSTODIAN TYPE ID
	CONSTRAINT FK_AUD_OBJ_AUD_TBL FOREIGN KEY (AUD_ID) REFERENCES AUD_TBL(ID),
	CONSTRAINT FK_AUD_OBJ_CST_TBL FOREIGN KEY (CST_ID_TYP) REFERENCES AUD_CD_TBL(ID)
);

CREATE INDEX AUD_OBJ_OBJ_ID_IDX ON AUD_OBJ_TBL(OBJ_ID);
CREATE INDEX AUD_OBJ_AUD_ID_IDX ON AUD_OBJ_TBL(AUD_ID);

-- TABLE FOR AUDIT ACTORS
CREATE TABLE AUD_ACT_TBL (
	ID INTEGER PRIMARY KEY AUTOINCREMENT, -- UNIQUE IDENTIFIER FOR THE AUDIT ACTOR ENTRY
	USR_ID VARCHAR(256), -- USER IDENTIFIER AS KNOWN BY THE SYSTEM
	USR_NAME VARCHAR(256), -- USER NAME AS KNOWN BY THE SYSTEM
	ROL_CD_ID BLOB(16), -- THE ROLE CODE OF THE ACTOR
	CONSTRAINT FK_AUD_ACT_ROL_CD_ID FOREIGN KEY (ROL_CD_ID) REFERENCES AUD_CD_TBL(ID)
);

-- ASSOCIATION TABLE BETWEEN AUDITS AND ACTORS
CREATE TABLE AUD_ACT_ASSOC_TBL (
	ID INTEGER PRIMARY KEY AUTOINCREMENT, -- UNIQUE IDENTIFIER FOR THE AUDIT ACTOR
	AUD_ID BLOB(16) NOT NULL, -- THE AUDIT TO WHICH THE ACTOR ENTRY BELONGS
	ACT_ID INTEGER NOT NULL, -- THE ACTOR TO WHICH THE ASOSCIATION BELONGS
	IS_RQO BOOLEAN NOT NULL DEFAULT FALSE, -- TRUE IF THE USER IS THE REQUESTOR OF THE ACTION
	AP VARCHAR(256) , -- ACCESS POINT
	CONSTRAINT FK_AUD_ACT_ASSOC_ACT_ID FOREIGN KEY (ACT_ID) REFERENCES AUD_ACT_TBL (ID),
	CONSTRAINT FK_AUD_ACT_ASSOC_AUD_ID FOREIGN KEY (AUD_ID) REFERENCES AUD_TBL (ID)
);

CREATE INDEX AUD_ACT_ASSOC_AUD_ID_IDX ON AUD_ACT_ASSOC_TBL(AUD_ID);

CREATE TABLE AUD_META_VAL_CDTBL (
	VAL_ID INTEGER PRIMARY KEY AUTOINCREMENT,
	VAL VARCHAR(256) NOT NULL
);


-- METADATA TABLE
CREATE TABLE AUD_META_TBL (
	ID INTEGER PRIMARY KEY AUTOINCREMENT,
	AUD_ID BLOB(16) NOT NULL,
	ATTR INT NOT NULL,
	VAL_ID INTEGER NOT NULL,
	CONSTRAINT FK_AUD_META_AUD_ID FOREIGN KEY (AUD_ID) REFERENCES AUD_TBL(ID),
	CONSTRAINT FK_AUD_META_VAL_ID FOREIGN KEY (VAL_ID) REFERENCES AUD_META_VAL_CDTBL(VAL_ID)
);

CREATE INDEX aud_meta_aud_id_idx ON aud_meta_tbl(aud_id);


 -- TABLE FOR STORAGE OF AUDIT OBJECTS
 CREATE TABLE AUD_OBJ_DAT_TBL (
	ID	INTEGER PRIMARY KEY AUTOINCREMENT,
	OBJ_ID BIGINT NOT NULL, -- OBJECT TO WHICH THE DATA BELONGS
	KEY VARCHAR(256), -- THE KEY OBJECT IDENTIFIER
	VAL BLOB, -- ADDITIONAL NAME DATA ASSIGNED TO THE OBJECT
	CONSTRAINT FK_AUD_OBJ_DAT_OBJ_TBL FOREIGN KEY (OBJ_ID) REFERENCES AUD_OBJ_TBL(ID)
);

CREATE INDEX AUD_OBJ_OBJ_DAT_ID_IDX ON AUD_OBJ_DAT_TBL(OBJ_ID);
