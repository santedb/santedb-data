/** 
 * <feature scope="SanteDB.Persistence.Data" id="20231116-02" name="Update:20231116-02" applyRange="1.1.0.0-1.2.0.0"  invariantName="FirebirdSQL">
 *	<summary>Update: Updates the storage of care plans and CDSS library logic</summary>
 *	<isInstalled>select ck_patch('20231116-02') from rdb$database</isInstalled>
 * </feature>
 */
 -- OPTIONAL
 CREATE TABLE CP_TBL 
 (
	ACT_VRSN_ID UUID NOT NULL,
	TITLE BLOB SUB_TYPE TEXT, 
	PROG VARCHAR(256),
	CONSTRAINT PK_CP_TBL PRIMARY KEY (ACT_VRSN_ID),
	CONSTRAINT FK_CP_ACT_VRSN_TBL FOREIGN KEY (ACT_VRSN_ID) REFERENCES ACT_VRSN_TBL(ACT_VRSN_ID)
 );--#!

 -- OPTIONAL
 -- CDSS LIBRARY STORAGE 
 CREATE TABLE CDSS_LIB_TBL (
	LIB_ID UUID NOT NULL,
	CLS VARCHAR(512) NOT NULL,
	IS_SYS BOOLEAN  DEFAULT FALSE NOT NULL,
	CONSTRAINT PK_CDSS_LIB_TBL PRIMARY KEY (LIB_ID)
);--#!

-- OPTIONAL
CREATE SEQUENCE CDSS_LIB_VRSN_SEQ;--#!

-- OPTIONAL
CREATE TABLE CDSS_LIB_VRSN_TBL (
	LIB_VRSN_ID UUID NOT NULL,
	LIB_ID UUID NOT NULL,
	VRSN_SEQ_ID BIGINT UNIQUE NOT NULL,
	RPLC_VRSN_ID UUID,
	HEAD BOOLEAN DEFAULT TRUE NOT NULL ,
	CRT_PROV_ID UUID NOT NULL,
	CRT_UTC TIMESTAMP DEFAULT CURRENT_TIMESTAMP NOT NULL ,
	OBSLT_PROV_ID UUID,
	OBSLT_UTC TIMESTAMP,
	ID VARCHAR(256) NOT NULL,
	NAME VARCHAR(512) NOT NULL,
	VER VARCHAR(256),
	OID VARCHAR(256),
	DOC BLOB SUB_TYPE TEXT,
	DEF BLOB NOT NULL,
	CONSTRAINT PK_CDSS_LIB_VRSN_TBL PRIMARY KEY (LIB_VRSN_ID),
	CONSTRAINT FK_CDSS_LIB_LIB_TBL FOREIGN KEY (LIB_ID) REFERENCES CDSS_LIB_TBL(LIB_ID),
	CONSTRAINT FK_CDSS_LIB_VRSN_CRT_PROV_TBL FOREIGN KEY (CRT_PROV_ID) REFERENCES SEC_PROV_TBL(PROV_ID),
	CONSTRAINT FK_CDSS_LIB_VRSN_OBSLT_PROV_TBL FOREIGN KEY (OBSLT_PROV_ID) REFERENCES SEC_PROV_TBL(PROV_ID),
	CONSTRAINT FK_CDSS_LIB_VRSN_RPLC_TBL FOREIGN KEY (RPLC_VRSN_ID) REFERENCES CDSS_LIB_VRSN_TBL(LIB_VRSN_ID),
	CONSTRAINT FK_OBSLT_PROV_LOGIC CHECK ((OBSLT_PROV_ID IS NULL AND OBSLT_UTC IS NULL) OR (OBSLT_PROV_ID IS NOT NULL AND OBSLT_UTC IS NOT NULL))
);--#!

-- OPTIONAL
CREATE TRIGGER TG_CDSS_LIB_VRSN_TBL_SEQ FOR CDSS_LIB_VRSN_TBL ACTIVE BEFORE INSERT POSITION 0 AS BEGIN
	NEW.VRSN_SEQ_ID = NEXT VALUE FOR CDSS_LIB_VRSN_SEQ;
END;--#!
-- OPTIONAL
CREATE UNIQUE INDEX CDSS_LIB_ID_IDX ON CDSS_LIB_VRSN_TBL(ID);--#!
-- OPTIONAL
CREATE UNIQUE INDEX CDSS_LIB_NAME_IDX ON CDSS_LIB_VRSN_TBL(NAME);--#!
-- OPTIONAL
CREATE INDEX CDSS_LIB_NAM_IDX ON CDSS_LIB_VRSN_TBL(NAME);--#!

-- FIX FOR SECURITY UPDATE ON HASHING PASSWORD
UPDATE SEC_USR_TBL SET PASSWD = 'fccafc669c1794ff753f05e3e42b9265eb5bbd39f5f75866791e8dc39eeb12dd' WHERE PASSWD = '59ff5973691ff75f8baa45f1e38fae24875f77ef00987ed22b02df075fb144f9'; --#!
UPDATE SEC_APP_TBL SET APP_SCRT = '734544ac69afe5549d33ecceadbbd3adf57650df52d3038b739da0d505fcf858' WHERE APP_SCRT = '015fe16693e1117c6c235d91dd535302d65e9259720416d606ab1a2b27a37ba3';--#!
UPDATE SEC_APP_TBL SET APP_SCRT = 'eb859ef5298b63eca82f53fdeba480e5a62b2072f27d8c4bf0b4cac30a3cdd93' WHERE APP_SCRT = '0180cad1928b9b9887a60a123920a793e7aa7cd339577876f0c233fa2b9fb7d6';--#!
UPDATE SEC_APP_TBL SET APP_SCRT = '517d8028957f60b2c7b5e7d1fe769f84060881f7c06386ba8d7ccf7a25621245' WHERE APP_SCRT = 'cba830db9a6f5a4b638ff95ef70e98aa82d414ac35b351389024ecb6be40ebf0';--#!

SELECT REG_PATCH('20231116-02') FROM RDB$DATABASE; --#!
