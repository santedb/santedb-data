/** 
 * <feature scope="SanteDB.Persistence.Data" id="20240104-03" name="Update:20240104-03" applyRange="1.1.0.0-1.2.0.0"  invariantName="sqlite">
 *	<summary>Update: Adds persistence of data quality rules in the primary database</summary>
 *	<isInstalled>select count(*) > 0 from patch_db_systbl WHERE PATCH_ID = '20240104-03'</isInstalled>
 * </feature>
 */
 --#!
 -- OPTIONAL
 CREATE TABLE DQ_CNF_SYSTBL (
	DQ_ID BLOB(16) DEFAULT (randomblob(16)) NOT NULL,
	ACTIVE INT DEFAULT 1 NOT NULL,
	MNEMONIC VARCHAR(256) NOT NULL, 
	NAME VARCHAR(512) NOT NULL,
	CRT_PROV_ID BLOB NOT NULL,
	CRT_UTC BIGINT DEFAULT(unixepoch()) NOT NULL,
	UPD_PROV_ID BLOB(16),
	UPD_UTC BIGINT,
	OBSLT_PROV_ID BLOB(16),
	OBSLT_UTC BIGINT,
	CONSTRAINT PK_DQ_CNF_SYSTBL PRIMARY KEY (DQ_ID),
	CONSTRAINT FK_DQ_CRT_PROV_TBL FOREIGN KEY (CRT_PROV_ID) REFERENCES SEC_PROV_TBL(PROV_ID),
	CONSTRAINT FK_DQ_UPD_PROV_TBL FOREIGN KEY (UPD_PROV_ID) REFERENCES SEC_PROV_TBL(PROV_ID),
	CONSTRAINT FK_DQ_OBSLT_PROV_TBL FOREIGN KEY (OBSLT_PROV_ID) REFERENCES SEC_PROV_TBL(PROV_ID),
	CONSTRAINT CK_OBSLT_PROV_LOGIC CHECK ((OBSLT_PROV_ID IS NULL AND OBSLT_UTC IS NULL) OR (OBSLT_PROV_ID IS NOT NULL AND OBSLT_UTC IS NOT NULL))
 );--#!
 -- OPTIONAL
 CREATE UNIQUE INDEX DQ_CNF_MNEMONIC_UQ_IDX ON DQ_CNF_SYSTBL(MNEMONIC) WHERE (OBSLT_UTC IS NULL); --#!
 -- OPTIONAL
 CREATE TABLE DQ_RES_SYSTBL (
	RES_ID BLOB(16) DEFAULT (randomblob(16)) NOT NULL,
	DQ_ID BLOB(16) NOT NULL,
	RES VARCHAR(128) NOT NULL,
	CONSTRAINT PK_DQ_RES_SYSTBL PRIMARY KEY (RES_ID),
	CONSTRAINT FK_DQ_RES_CNF_SYSTBL FOREIGN KEY (DQ_ID) REFERENCES DQ_CNF_SYSTBL(DQ_ID)
); --#!
-- OPTIONAL
CREATE TABLE DQ_RES_ASRT_SYSTBL (
	ASRT_ID BLOB(16) DEFAULT (randomblob(16)) NOT NULL,
	RES_ID BLOB(16) NOT NULL,
	MNEMONIC VARCHAR(256) NOT NULL UNIQUE,
	TXT TEXT NOT NULL,
	PRI INT NOT NULL DEFAULT 4,
	EVAL INT NOT NULL DEFAULT 0,
	EXPR TEXT NOT NULL,
	CONSTRAINT PK_REQ_ASRT_SYSTBL PRIMARY KEY (ASRT_ID),
	CONSTRAINT FK_RES_ASRT_RES_SYSTBL FOREIGN KEY (RES_ID) REFERENCES DQ_RES_SYSTBL(RES_ID)
); --#!
-- OPTIONAL
CREATE INDEX DQ_RES_ASRT_RES_IDX ON DQ_RES_ASRT_SYSTBL(RES_ID); --#!

-- FIX FOR SECURITY UPDATE ON HASHING PASSWORD
UPDATE SEC_USR_TBL SET PASSWD = 'fccafc669c1794ff753f05e3e42b9265eb5bbd39f5f75866791e8dc39eeb12dd' WHERE PASSWD = '59ff5973691ff75f8baa45f1e38fae24875f77ef00987ed22b02df075fb144f9';
UPDATE SEC_APP_TBL SET APP_SCRT = '734544ac69afe5549d33ecceadbbd3adf57650df52d3038b739da0d505fcf858' WHERE APP_SCRT = '015fe16693e1117c6c235d91dd535302d65e9259720416d606ab1a2b27a37ba3';
UPDATE SEC_APP_TBL SET APP_SCRT = 'eb859ef5298b63eca82f53fdeba480e5a62b2072f27d8c4bf0b4cac30a3cdd93' WHERE APP_SCRT = '0180cad1928b9b9887a60a123920a793e7aa7cd339577876f0c233fa2b9fb7d6';
UPDATE SEC_APP_TBL SET APP_SCRT = '517d8028957f60b2c7b5e7d1fe769f84060881f7c06386ba8d7ccf7a25621245' WHERE APP_SCRT = 'cba830db9a6f5a4b638ff95ef70e98aa82d414ac35b351389024ecb6be40ebf0';

--#!
-- OPTIONAL
ALTER TABLE job_stat_systbl ADD last_sts_txt TEXT; --#!

INSERT INTO PATCH_DB_SYSTBL (PATCH_ID, APPLY_DATE, INFO_NAME) VALUES ('20240104-03', UNIXEPOCH(), 'Adds DQ storage tables to database'); 
